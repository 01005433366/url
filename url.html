<!DOCTYPE html><html lang="en-US"><meta charset="utf-8">
<title>URL Standard</title>
<link href="//www.whatwg.org/style/specification" rel="stylesheet">
<link href="//resources.whatwg.org/logo-url.svg" rel="icon">

<div class="head">

<p><a class="logo" href="//www.whatwg.org/"><img alt="WHATWG" height="100" src="//resources.whatwg.org/logo-url.svg" width="100"></a></p>
<h1>URL</h1>
<h2 class="no-num no-toc" id="living-standard-—-last-updated-10-november-2012">Living Standard — Last Updated 10 November 2012</h2>

<dl>
 <dt>This Version:
 <dd><a href="//url.spec.whatwg.org/">http://url.spec.whatwg.org/</a>

 <dt>Participate:</dt>
 <dd>Send feedback to
  <a href="http://www.whatwg.org/mailing-list">whatwg@whatwg.org</a>
  (<a href="http://www.whatwg.org/mailing-list#specs">archives</a>) or
  <a href="https://www.w3.org/Bugs/Public/enter_bug.cgi?product=WHATWG&amp;component=URL">file a bug</a>
  (<a href="https://www.w3.org/Bugs/Public/buglist.cgi?product=WHATWG&amp;component=URL&amp;resolution=---">open bugs</a>)
 <dd><a href="http://wiki.whatwg.org/wiki/IRC">IRC: #whatwg on Freenode</a>

 <dt>Version History:
 <dd><a href="https://github.com/whatwg/url/commits">https://github.com/whatwg/url/commits</a>
 <dd><a href="https://twitter.com/urlstandard">@urlstandard</a>

 <dt>Editor:
 <dd class="h-card vcard"><a class="u-url url p-name fn" href="http://annevankesteren.nl/" lang="nl">Anne van Kesteren</a>
  &lt;<a class="u-email email" href="mailto:annevk@annevk.nl">annevk@annevk.nl</a>&gt;
</dl>

<script async="" src="//resources.whatwg.org/file-bug.js"></script>

<p class="copyright"><a href="http://creativecommons.org/publicdomain/zero/1.0/" rel="license"><img alt="CC0" src="http://i.creativecommons.org/p/zero/1.0/80x15.png"></a>
To the extent possible under law, the editors have waived all copyright and
related or neighboring rights to this work. In addition, as of
10 November 2012, the editors have made this specification available
under the
<a href="http://www.openwebfoundation.org/legal/the-owf-1-0-agreements/owfa-1-0" rel="license">Open Web Foundation Agreement Version 1.0</a>,
which is available at
http://www.openwebfoundation.org/legal/the-owf-1-0-agreements/owfa-1-0.

</div>



<h2 class="no-num no-toc" id="table-of-contents">Table of Contents</h2>

<!--begin-toc-->
<ol class="toc">
 <li><a class="no-num" href="#goals">Goals</a></li>
 <li><a href="#conformance"><span class="secno">1 </span>Conformance</a></li>
 <li><a href="#terminology"><span class="secno">2 </span>Terminology</a></li>
 <li><a href="#hosts-and-ip-addresses"><span class="secno">3 </span>Hosts and IP addresses</a>
  <ol>
   <li><a href="#host-writing"><span class="secno">3.1 </span>Writing</a></li>
   <li><a href="#host-parsing"><span class="secno">3.2 </span>Parsing</a></li>
   <li><a href="#host-serializing"><span class="secno">3.3 </span>Serializing</a></ol></li>
 <li><a href="#urls"><span class="secno">4 </span>URLs</a>
  <ol>
   <li><a href="#writing"><span class="secno">4.1 </span>Writing</a></li>
   <li><a href="#parsing"><span class="secno">4.2 </span>Parsing</a></li>
   <li><a href="#serializing"><span class="secno">4.3 </span>Serializing</a></ol></li>
 <li><a href="#api"><span class="secno">5 </span>API</a>
  <ol>
   <li><a href="#constructors"><span class="secno">5.1 </span>Constructors</a></li>
   <li><a href="#interface-urlutils"><span class="secno">5.2 </span>Interface <code title="">URLUtils</code></a></li>
   <li><a href="#interface-urlquery"><span class="secno">5.3 </span>Interface <code title="">URLQuery</code></a></ol></li>
 <li><a class="no-num" href="#references">References</a></li>
 <li><a class="no-num" href="#acknowledgments">Acknowledgments</a></ol>
<!--end-toc-->



<h2 class="no-num" id="goals">Goals</h2>

<p>The URL standard sets out to make URLs fully predictable and
interoperable. This is the plan:

<ul>
 <li><p>Align RFC 3986 and RFC 3987 with contemporary implementations and
 obsolete them in the process. (E.g. spaces, other "illegal" code points,
 query encoding, equality, canonicalization, are all concepts not entirely
 shared, or defined.) URL parsing needs to become as solid as HTML parsing.
 <a class="informative" href="#refsRFC3986">[RFC3986]</a>
 <a class="informative" href="#refsRFC3987">[RFC3987]</a>

 <li><p>Standardize on the term URL. URI and IRI are just confusing. In
 practice a single algorithm is used for both so keeping them distinct is
 not helping anyone. URL also easily wins the
 <a href="http://www.googlefight.com/index.php?word1=url&amp;word2=uri">search result popularity contest</a>.

 <li><p>Define URL's existing JavaScript API in full detail and add
 enhancements to make it easier to work with. Add a new <a href="#url"><code>URL</code></a>
 object as well for URL manipulation without usage of HTML elements. (Useful
 for Web Workers.)
</ul>

<p class="note">As the editor learns more about the subject matter the goals
might increase in scope somewhat.



<h2 id="conformance"><span class="secno">1 </span>Conformance</h2>
<p>All diagrams, examples, and notes in this specification are
non-normative, as are all sections explicitly marked non-normative.
Everything else in this specification is normative.

<p>The key words "MUST", "MUST NOT", "REQUIRED", <!--"SHALL", "SHALL
NOT",--> "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and
"OPTIONAL" in the normative parts of this specification are to be
interpreted as described in RFC2119. For readability, these words do
not appear in all uppercase letters in this specification.
<a href="#refsRFC2119">[RFC2119]</a>



<h2 id="terminology"><span class="secno">2 </span>Terminology</h2>

<p>Some terms used in this specification are defined in the
Encoding Standard. <a href="#refsENCODING">[ENCODING]</a>

<p>The <dfn id="ascii-digits">ASCII digits</dfn> are code points in the range U+0030 to U+0039.

<p>The <dfn id="ascii-hex-digits">ASCII hex digits</dfn> are <a href="#ascii-digits">ASCII digits</a> or are
code points in the range U+0041 to U+0046 or in the range U+0061 to U+0066.

<p>The <dfn id="ascii-alpha">ASCII alpha</dfn> are code points in the range U+0041 to U+005A
or in the range U+0061 to U+007A.

<p>The <dfn id="ascii-alphanumeric">ASCII alphanumeric</dfn> are <a href="#ascii-digits">ASCII digits</a> or
<a href="#ascii-alpha">ASCII alpha</a>.


<p>The <dfn id="domain-label-separators">domain label separators</dfn> are the code points
U+002E, U+3002, U+FF0E, and U+FF61.
<!-- IDNA2003/UTS #46; IDNA2008 does not define these -->


<p>A <dfn id="url-encoded-byte">URL-encoded byte</dfn> is "<code title="">%</code>", followed by two
<a href="#ascii-hex-digits">ASCII hex digits</a>.

<p class="note">For maximum robustness, sequences of
<a href="#url-encoded-byte" title="URL-encoded byte">URL-encoded bytes</a>, after conversion to
bytes, ought to not cause
<a class="external" data-anolis-spec="encoding" href="http://encoding.spec.whatwg.org/#utf-8-decode">utf-8 decode</a> to emit one or more
<a class="external" data-anolis-spec="encoding" href="http://encoding.spec.whatwg.org/#decoder-error" title="decoder error">decoder errors</a>.

<p>To <dfn id="url-encode">URL encode</dfn> a <var title="">byte</var> into a
<a href="#url-encoded-byte">URL-encoded byte</a>, return a string consisting of
"<code title="">%</code>", followed by a double-digit, uppercase, hexadecimal
representation of <var title="">byte</var>.



<h2 id="hosts-and-ip-addresses"><span class="secno">3 </span>Hosts and IP addresses</h2>

<!-- Punycode:
     http://tools.ietf.org/html/rfc3492
     http://mothereff.in/punycode -->

<p>A <dfn id="concept-host" title="concept-host">host</dfn> is a string that represents a
network address, either in the form of a
<a href="#concept-domain" title="concept-domain">domain</a> or an
<a href="#concept-ipv6" title="concept-ipv6">IPv6 address</a>.

<p class="note">This is a slightly more generic definition of
<a href="#concept-host" title="concept-host">host</a> than its traditional meaning for the
sake of convenience.
<!-- "convenience's sake" as The Economist would write it is ugly -->

<p>A <dfn id="concept-domain" title="concept-domain">domain</dfn> is an ordered list of one or
more <dfn id="concept-domain-label" title="concept-domain-label">domain labels</dfn>.

<p class="XXX">An <dfn id="concept-ipv6" title="concept-ipv6">IPv6 address</dfn> is ...


<h3 id="host-writing"><span class="secno">3.1 </span>Writing</h3>

<p>A <a href="#concept-domain" title="concept-domain">domain</a> must be one or more
<a href="#concept-domain-label" title="concept-domain-label">domain labels</a> separated from each
other by a
<a href="#domain-label-separators" title="domain label separators">domain label separator</a>,
optionally followed by a
<a href="#domain-label-separators" title="domain label separators">domain label separator</a>.
<!-- if a domain has 4 labels, no trailing dot, and each label consists only
     of ASCII digits it's IPv4 because the last label of a domain cannot
     start with an ASCII digit -->

<p class="XXX">An <a href="#concept-ipv6" title="concept-ipv6">IPv6 address</a> must ...


<h3 id="host-parsing"><span class="secno">3.2 </span>Parsing</h3>

<p class="XXX">IDNA2003 vs IDNA2008 (and also UTS #46)

<p>A <dfn id="concept-parsed-host" title="concept-parsed-host">parsed host</dfn> consists either of a
<a href="#concept-parsed-domain" title="concept-parsed-domain">parsed domain</a> or a
<a href="#concept-parsed-ipv6" title="concept-parsed-ipv6">parsed IPv6 address</a>.

<p>A <dfn id="concept-parsed-domain" title="concept-parsed-domain">parsed domain</dfn> consists of a list
of <a href="#concept-domain-label" title="concept-domain-label">labels</a> and a
<dfn id="trailing-dot-flag">trailing dot flag</dfn>.

<p>A <dfn id="concept-parsed-ipv6" title="concept-parsed-ipv6">parsed IPv6 address</dfn> consists of an
ordered set of eight 16-bit integers.

<p classxxx="">To <dfn id="concept-host-parser" title="concept-host-parser">parse</dfn> ...

<!-- http://tools.ietf.org/html/rfc4291 -->


<h3 id="host-serializing"><span class="secno">3.3 </span>Serializing</h3>

<p class="XXX">Normalize IPv6 addresses
<!-- Safari/Gecko/Opera do not do this. Chrome does. I would prefer aligning
     with Chrome as we normalize domains too.

     http://tools.ietf.org/html/rfc5952#section-4 has recommendations, but
     no algorithm. -->



<h2 id="urls"><span class="secno">4 </span>URLs</h2>

<!-- History behind URL as term:
     http://lists.w3.org/Archives/Public/uri/2012Oct/0080.html -->

<p>A <dfn id="concept-url" title="concept-url">URL</dfn> is a string that represents an
identifier.

<p>A <a href="#concept-url" title="concept-url">URL</a> is either a
<a href="#concept-relative-url" title="concept-relative-url">relative URL</a> or an
<a href="#concept-absolute-url" title="concept-absolute-url">absolute URL</a>. Either form can be
followed by a <a href="#concept-url-fragment" title="concept-url-fragment">fragment</a>.

<p>A <dfn id="concept-relative-url" title="concept-relative-url">relative URL</dfn> is a
<a href="#concept-url" title="concept-url">URL</a> that is relative to a
<a href="#concept-parsed-url" title="concept-parsed-url">parsed URL</a>. Such a
<a href="#concept-parsed-url" title="concept-parsed-url">parsed URL</a> is a
<dfn id="concept-base-url" title="concept-base-url">base URL</dfn>. If the
<a href="#concept-base-url" title="concept-base-url">base URL</a> has no
<a href="#relative-scheme">relative scheme</a>, <a href="#concept-url-parser" title="concept-url-parser">parsing</a>
the <a href="#concept-relative-url" title="concept-relative-url">relative URL</a> results in a
fatal error.

<p>An <dfn id="concept-absolute-url" title="concept-absolute-url">absolute URL</dfn> stands on its own
and is therefore a potential <a href="#concept-base-url" title="concept-base-url">base URL</a>.

<p>Provided there are no fatal errors,
<a href="#concept-url-parser" title="concept-url-parser">parsing</a> and
<a href="#concept-url-serializer" title="concept-url-serializer">serializing</a> a
<a href="#concept-url" title="concept-url">URL</a> will turn it into an
<a href="#concept-absolute-url" title="concept-absolute-url">absolute URL</a>. The intermediate form
is named a <dfn id="concept-parsed-url" title="concept-parsed-url">parsed URL</dfn>. The components a
<a href="#concept-url" title="concept-url">URL</a> can consist of and
<a href="#concept-parsed-url" title="concept-parsed-url">parsed URL</a> consists of are
<dfn id="concept-url-scheme" title="concept-url-scheme">scheme</dfn>,
<dfn id="concept-url-scheme-data" title="concept-url-scheme-data">scheme data</dfn> (not used if
<a href="#concept-url-scheme" title="concept-url-scheme">scheme</a> is a <a href="#relative-scheme">relative scheme</a>),
<dfn id="concept-url-userinfo" title="concept-url-userinfo">userinfo</dfn>,
<dfn id="concept-url-host" title="concept-url-host">host</dfn>,
<dfn id="concept-url-port" title="concept-url-port">port</dfn>,
<dfn id="concept-url-path" title="concept-url-path">path</dfn>,
<dfn id="concept-url-query" title="concept-url-query">query</dfn>, and
<dfn id="concept-url-fragment" title="concept-url-fragment">fragment</dfn>.

<p>A <dfn id="relative-scheme">relative scheme</dfn> is a
<a href="#concept-url-scheme" title="concept-url-scheme">scheme</a> listed in the first column of
the following table. It typically has an associated default
<a href="#concept-url-port" title="concept-url-port">port</a> listed in the second column on the
same row.

<table>
 <tr><th><a href="#concept-url-scheme" title="concept-url-scheme">scheme</a>
     <th><a href="#concept-url-port" title="concept-url-port">port</a>
 <tr><td>"<code title="">ftp</code>"<td>21
 <tr><td>"<code title="">file</code>"<td>
 <tr><td>"<code title="">gopher</code>"<td>70
 <tr><td>"<code title="">http</code>"<td>80
 <tr><td>"<code title="">https</code>"<td>443
 <tr><td>"<code title="">ws</code>"<td>80
 <tr><td>"<code title="">wss</code>"<td>443
</table>


<h3 id="writing"><span class="secno">4.1 </span>Writing</h3>

<!-- http://tantek.com/2011/238/b1/many-ways-slice-url-name-pieces -->

<p>A <a href="#concept-url" title="concept-url">URL</a> must be either a
<a href="#concept-relative-url" title="concept-relative-url">relative URL</a> or an
<a href="#concept-absolute-url" title="concept-absolute-url">absolute URL</a>, optionally followed by
"<code title="">#</code>" and a
<a href="#concept-url-fragment" title="concept-url-fragment">fragment</a>.

<p>An <a href="#concept-absolute-url" title="concept-absolute-url">absolute URL</a> is a
<a href="#concept-url-scheme" title="concept-url-scheme">scheme</a>, followed by
"<code title="">:</code>", followed by
<a href="#concept-url-scheme-data" title="concept-url-scheme-data">scheme data</a>.

<p>A <a href="#concept-url-scheme" title="concept-url-scheme">scheme</a> is one
<a href="#ascii-alpha">ASCII alpha</a>, followed by zero or more of
<a href="#ascii-alphanumeric">ASCII alphanumeric</a>, "<code title="">+</code>",
"<code title="">-</code>", and "<code title="">.</code>". A
<a href="#concept-url-scheme" title="concept-url-scheme">scheme</a> must be registered
<span class="XXX">...</span>.

<p>The syntax of <a href="#concept-url-scheme-data" title="concept-url-scheme-data">scheme data</a>
depends on the <a href="#concept-url-scheme" title="concept-url-scheme">scheme</a> and is typically
defined alongside it. For a <a href="#relative-scheme">relative scheme</a>,
<a href="#concept-url-scheme-data" title="concept-url-scheme-data">scheme data</a> is a
<a href="#concept-scheme-relative-url" title="concept-scheme-relative-url">scheme-relative URL</a>. For
other <a href="#concept-url-scheme" title="concept-url-scheme">schemes</a>, specifications or
standards must define <a href="#concept-url-scheme-data" title="concept-url-scheme-data">scheme data</a>
either literally as or as a subset of one or more <a href="#url-units">URL units</a>
that do not start with "<code title="">?</code>".

<p>A <a href="#concept-relative-url" title="concept-relative-url">relative URL</a> is either a
<a href="#concept-scheme-relative-url" title="concept-scheme-relative-url">scheme-relative URL</a>, an
<a href="#concept-absolute-path-relative-url" title="concept-absolute-path-relative-url">absolute-path-relative URL</a>,
or a <a href="#concept-path-relative-url" title="concept-path-relative-url">path-relative URL</a> that
does not start with a <a href="#concept-url-scheme" title="concept-url-scheme">scheme</a> and
"<code title="">:</code>". A
<a href="#concept-relative-url" title="concept-relative-url">relative URL</a> must be relative to a
<a href="#concept-base-url" title="concept-base-url">base URL</a> with a
<a href="#relative-scheme">relative scheme</a>.

<p>A <dfn id="concept-scheme-relative-url" title="concept-scheme-relative-url">scheme-relative URL</dfn> is
"<code title="">//</code>", optionally followed by
<a href="#concept-url-userinfo" title="concept-url-userinfo">userinfo</a> and "<code title="">@</code>",
followed by a <a href="#concept-host" title="concept-host">host</a>, optionally followed
by "<code title="">:</code>" and a <a href="#concept-url-port" title="concept-url-port">port</a>,
optionally followed by either an
<a href="#concept-absolute-path-relative-url" title="concept-absolute-path-relative-url">absolute-path-relative URL</a>
or a "<code title="">?</code>" and a <a href="#concept-url-query" title="concept-url-query">query</a>.

<p>A <a href="#concept-url-userinfo" title="concept-url-userinfo">userinfo</a> is zero or more
<a href="#url-units">URL units</a>, excluding "<code title="">/</code>",
"<code title="">?</code>", and "<code title="">@</code>".

<p>A <a href="#concept-url-port" title="concept-url-port">port</a> is zero or more
<a href="#ascii-digits">ASCII digits</a>.

<p>An
<dfn id="concept-absolute-path-relative-url" title="concept-absolute-path-relative-url">absolute-path-relative URL</dfn>
is "<code title="">/</code>", followed by a
<a href="#concept-path-relative-url" title="concept-path-relative-url">path-relative URL</a> that does not
start with "<code title="">/</code>".

<p>A <dfn id="concept-path-relative-url" title="concept-path-relative-url">path-relative URL</dfn> is zero or
more <a href="#path-segment" title="path segment">path segments</a> separated from each
other by a "<code title="">/</code>", optionally followed by a
"<code title="">?</code>" and a <a href="#concept-url-query" title="concept-url-query">query</a>.

<p>A <dfn id="path-segment">path segment</dfn> is zero or more <a href="#url-units">URL units</a>,
excluding "<code title="">/</code>" and "<code title="">?</code>".

<p>A <a href="#concept-url-query" title="concept-url-query">query</a> is zero or more
<a href="#url-units">URL units</a>.

<p>A <a href="#concept-url-fragment" title="concept-url-fragment">fragment</a> is zero or more
<a href="#url-units">URL units</a>.

<p>The <dfn id="url-units">URL units</dfn> are <a href="#ascii-alphanumeric">ASCII alphanumeric</a>,
"<code title="">!</code>",<!-- 0x21, sub-delims -->
"<code title="">$</code>",<!-- 0x24, sub-delims -->
"<code title="">&amp;</code>",<!-- 0x26, sub-delims -->
"<code title="">'</code>",<!-- 0x27, sub-delims -->
"<code title="">(</code>",<!-- 0x28, sub-delims -->
"<code title="">)</code>",<!-- 0x29, sub-delims -->
"<code title="">*</code>",<!-- 0x2A, sub-delims -->
"<code title="">+</code>",<!-- 0x2B, sub-delims -->
"<code title="">,</code>",<!-- 0x2C, sub-delims -->
"<code title="">-</code>",<!-- 0x2D, iunreserved -->
"<code title="">.</code>",<!-- 0x2E, iunreserved -->
"<code title="">/</code>",<!-- 0x2F, iquery/ifragment -->
"<code title="">:</code>",<!-- 0x3A, ipchar -->
"<code title="">;</code>",<!-- 0x3B, sub-delims -->
"<code title="">=</code>",<!-- 0x3D, sub-delims -->
"<code title="">?</code>",<!-- 0x3F, iquery/ifragment -->
"<code title="">@</code>",<!-- 0x40, ipchar -->
"<code title="">_</code>",<!-- 0x5F, iunreserved -->
"<code title="">~</code>",<!-- 0x7E, iunreserved -->
code points in the ranges
U+00A0 to U+D7FF,
U+E000 to <!--U+F8FF,
U+F900 to -->U+FDCF,
U+FDF0 to U+FFEF,
U+10000 to U+1FFFD,
U+20000 to U+2FFFD,
U+30000 to U+3FFFD,
U+40000 to U+4FFFD,
U+50000 to U+5FFFD,
U+60000 to U+6FFFD,
U+70000 to U+7FFFD,
U+80000 to U+8FFFD,
U+90000 to U+9FFFD,
U+A0000 to U+AFFFD,
U+B0000 to U+BFFFD,
U+C0000 to U+CFFFD,
U+D0000 to U+DFFFD,
U+E1000 to U+EFFFD,
U+F0000 to U+FFFFD,
U+100000 to U+10FFFD,
and <a href="#url-encoded-byte" title="URL-encoded byte">URL-encoded bytes</a>.
<!-- XXX there is a mismatch with
     http://www.whatwg.org/specs/web-apps/current-work/#preprocessing-the-input-stream
     I think they should match, need advice -->

<p class="note">Code points higher than U+009F will be converted to
<a href="#url-encoded-byte" title="URL-encoded byte">URL-encoded bytes</a> by the
<a href="#concept-url-parser" title="concept-url-parser">parser</a>.



<h3 id="parsing"><span class="secno">4.2 </span>Parsing</h3>

<p>Aside from the components mentioned earlier, a
<a href="#concept-parsed-url" title="concept-parsed-url">parsed URL</a> also has an associated
<dfn id="fatal-error-flag">fatal error flag</dfn> and <dfn id="relative-flag">relative flag</dfn>.

<p>To <dfn id="clear">clear</dfn> a <a href="#concept-parsed-url" title="concept-parsed-url">parsed URL</a>,
set its <a href="#concept-url-scheme" title="concept-url-scheme">scheme</a>,
<a href="#concept-url-scheme-data" title="concept-url-scheme-data">scheme data</a>,
<a href="#concept-url-userinfo" title="concept-url-userinfo">userinfo</a>,
<a href="#concept-url-host" title="concept-url-host">host</a>, and
<a href="#concept-url-port" title="concept-url-port">port</a> to the empty string,
<a href="#concept-url-query" title="concept-url-query">query</a> and
<a href="#concept-url-fragment" title="concept-url-fragment">fragment</a> to null, and
its <a href="#concept-url-path" title="concept-url-path">path</a> to the empty list.

<p>To <dfn id="neuter">neuter</dfn> a
<a href="#concept-parsed-url" title="concept-parsed-url">parsed URL</a>, <a href="#clear">clear</a> it, and
then set its <a href="#fatal-error-flag">fatal error flag</a>.

<!-- the escape sets are minimal as escaping can lead to problems; we might
     be able to escape more here but only if implementors are willing and
     there's an upside -->
<p>The <dfn id="url-simple-escape-set">URL simple escape set</dfn> are all code points less than
U+0020 (i.e. excluding U+0020) and all code points greater than U+007E.

<p>The <dfn id="url-default-escape-set">URL default escape set</dfn> are
all code points less than U+0021,
all code points greater than U+007E,
'<code title="">"</code>', <!-- 0x22 -->
"<code title="">#</code>", <!-- 0x23 -->
"<code title="">&lt;</code>", <!-- 0x3C -->
"<code title="">&gt;</code>", <!-- 0x3E -->
"<code title="">?</code>", <!-- 0x3F -->
and
"<code title="">`</code>". <!-- 0x60 -->

<p>The <dfn id="url-query-escape-set">URL query escape set</dfn> are
all code points less than U+0021,
all code points greater than U+007E,
'<code title="">"</code>', <!-- 0x22 -->
"<code title="">#</code>", <!-- 0x23 -->
"<code title="">&lt;</code>", <!-- 0x3C -->
"<code title="">&gt;</code>", <!-- 0x3E -->
and
"<code title="">`</code>". <!-- 0x60 -->

<!-- we could inline handling of the EOF code point, U+0009, U+000A, and
     U+000D potentially; have them return the empty string -->
<p>To <dfn id="url-escape">URL escape</dfn> a <var title="">code point</var>, using an
<var title="">escape set</var>, and an optional
<var title="">encoding override</var>, run these steps:

<ol>
 <li><p>Let <var title="">encoding</var> be <var title="">encoding override</var>,
 if given, and <a class="external" data-anolis-spec="encoding" href="http://encoding.spec.whatwg.org/#utf-8">utf-8</a> otherwise.

 <li><p>If <var title="">code point</var> is not in
 <var title="">escape set</var>, return <var title="">code point</var>.

 <li>
  <p>Let <var title="">bytes</var> be the result of running
  <a class="external" data-anolis-spec="encoding" href="http://encoding.spec.whatwg.org/#encode">encode</a> on
  <var title="">code point</var> using <var title="">encoding</var> as
  <a class="external" data-anolis-spec="encoding" href="http://encoding.spec.whatwg.org/#encoding">encoding</a>.

  <p>Whenever the <a class="external" data-anolis-spec="encoding" href="http://encoding.spec.whatwg.org/#encoder">encoder</a> algorithm
  emits an <a class="external" data-anolis-spec="encoding" href="http://encoding.spec.whatwg.org/#encoder-error">encoder error</a>, emit a
  0x3F byte instead and do not terminate the algorithm.

  <p class="note">Using <a class="external" data-anolis-spec="encoding" href="http://encoding.spec.whatwg.org/#utf-8">utf-8</a> ensures
  you never hit an <a class="external" data-anolis-spec="encoding" href="http://encoding.spec.whatwg.org/#encoder-error">encoder error</a>
  here, but unfortunately legacy content uses other
  <a class="external" data-anolis-spec="encoding" href="http://encoding.spec.whatwg.org/#encoding" title="encoding">encodings</a>.

 <li><p><a href="#url-encode">URL encode</a> each byte in <var title="">bytes</var>, and
 then return them concatenated, in the same order.
</ol>

<p class="XXX">Add the ability to halt on the first conformance error.

<p>To <dfn id="concept-url-parser" title="concept-url-parser">parse</dfn> a string
<var title="">input</var>, optionally with a
<a href="#concept-base-url" title="concept-base-url">base URL</a> <var title="">base</var>,
optionally with an <a class="external" data-anolis-spec="encoding" href="http://encoding.spec.whatwg.org/#encoding">encoding</a>
<var title="">encoding override</var>, optionally with an
<a href="#concept-parsed-url" title="concept-parsed-url">parsed URL</a> <var title="">url</var>, and
if <var title="">url</var> is given, optionally with a state override
<var title="">state override</var>, run these steps:

<p class="note">The <var title="">url</var> and <var title="">state override</var>
arguments can be used for API manipulation of a
<a href="#concept-parsed-url" title="concept-parsed-url">parsed URL</a>.

<ol>
 <li>
  <p>If <var title="">url</var> is not given:

  <ol>
   <li><p>Set <var title="">url</var> to a new
   <a href="#concept-parsed-url" title="concept-parsed-url">parsed URL</a>.

   <li><p><a href="#clear">Clear</a> <var title="">url</var>.

   <li><p>Remove any leading and trailing
   <a class="external" data-anolis-spec="encoding" href="http://encoding.spec.whatwg.org/#ascii-whitespace">ASCII whitespace</a> from
   <var title="">input</var>.
  </ol>

 <li><p>Let <var title="">state</var> be <var title="">state override</var>
 if given, or <b title="">scheme start state</b> otherwise.

 <li><p>If <var title="">base</var> is not given, set it to null.

 <li><p>If <var title="">encoding override</var> is not given, set it to
 <a class="external" data-anolis-spec="encoding" href="http://encoding.spec.whatwg.org/#utf-8">utf-8</a>.

 <li><p>Let <var title="">buffer</var> be the empty string.

 <li><p>Let the <var title="">@ flag</var> and the <var title="">[] flag</var> be
 unset.

 <li><p>Append a conceptual <dfn id="eof-code-point">EOF code point</dfn>
 (to signify end-of-input) to <var title="">input</var>.

 <li><p>Let <var title="">pointer</var> be a pointer to first code point in
 <var title="">input</var>.

 <li>
  <p>Keep running the following state machine by switching on
  <var title="">state</var>, increasing <var title="">pointer</var> by one after
  each time it is run, as long as
  <var title="">url</var>'s <a href="#fatal-error-flag">fatal error flag</a> is not set and as
  long as <var title="">pointer</var> does not point past the end of
  <var title="">input</var>.

  <p>Let <var title="">c</var> be the code point to which
  <var title="">pointer</var> points.

  <p>Let <var title="">remaining</var> be the substring starting after
  <var title="">pointer</var> in <var title="">input</var>.

  <p class="example">If <var title="">input</var> is
  "<code title="">mailto:example@example</code>" (omitting the
  <a href="#eof-code-point">EOF code point</a> here) and <var title="">pointer</var> points to
  "<code title="">@</code>", <var title="">remaining</var> is
  "<code title="">example</code>" (again omitting the
  <a href="#eof-code-point">EOF code point</a>).

  <dl class="switch">
   <dt><b title="">scheme start state</b>
   <dd>
    <ol>
     <li><p>If <var title="">c</var> is not the <a href="#eof-code-point">EOF code point</a> and
     is in the range U+0041 through to U+005A or U+0061 through to U+007A,
     append <var title="">c</var>, lowercased, to <var title="">buffer</var>, and
     set <var title="">state</var> to <b title="">scheme state</b>.

     <li><p>Otherwise, if <var title="">state override</var> is not given, set
     <var title="">buffer</var> to the empty string, set <var title="">state</var>
     to <b title="">no scheme state</b>, and decrease <var title="">pointer</var>
     by one.

     <li><p>Otherwise, terminate this algorithm.
    </ol>

   <dt><b title="">scheme state</b>
   <dd>
    <ol>
     <li><p>If <var title="">c</var> is not the <a href="#eof-code-point">EOF code point</a> and
     is in the range U+0030 through to U+0039, U+0041 through to U+005A,
     U+0061 through to U+007A, or <var title="">c</var> is
     "<code title="">+</code>", "<code title="">-</code>", or
     "<code title="">.</code>", append <var title="">c</var>, lowercased, to
     <var title="">buffer</var>.

     <li>
      <p>Otherwise, if <var title="">c</var> is "<code title="">:</code>", set
      <var title="">url</var>'s <a href="#concept-url-scheme" title="concept-url-scheme">scheme</a> to
      <var title="">buffer</var>, <var title="">buffer</var> to the empty string,
      and then run these substeps:

      <ol>
       <li><p>If <var title="">state override</var> is given,
       terminate this algorithm.

       <li><p>If <var title="">url</var>'s
       <a href="#concept-url-scheme" title="concept-url-scheme">scheme</a> is
       a <a href="#relative-scheme">relative scheme</a>, set <var title="">url</var>'s
       <a href="#relative-flag">relative flag</a>.

       <li><p>If <var title="">url</var>'s
       <a href="#concept-url-scheme" title="concept-url-scheme">scheme</a> is
       "<code title="">file</code>", set <var title="">state</var> to
       <b title="">relative state</b>.
       <!-- not combined with the subsequent step for clarity -->

       <li><p>Otherwise, if <var title="">url</var>'s
       <a href="#relative-flag">relative flag</a> is set, <var title="">base</var> is not null
       and <var title="">base</var>'s
       <a href="#concept-url-scheme" title="concept-url-scheme">scheme</a> is equal to
       <var title="">url</var>'s <a href="#concept-url-scheme" title="concept-url-scheme">scheme</a>,
       set <var title="">state</var> to <b title="">relative state</b>.

       <li><p>Otherwise, if <var title="">url</var>'s
       <a href="#relative-flag">relative flag</a> is set, set <var title="">state</var> to
       <b title="">authority start state</b>.

       <li><p>Otherwise, set <var title="">state</var> to
       <b title="">scheme data state</b>.
      </ol>

     <li><p>Otherwise, set <var title="">state</var> to <b title="">no scheme state</b>,
     <var title="">buffer</var> to the empty string, and start over (from the
     first code point in <var title="">input</var>).
    </ol>

   <dt><b title="">scheme data state</b>
   <dd>
    <ol>
     <li><p>If <var title="">state override</var> is not given and <var title="">c</var>
     is "<code title="">#</code>", set <var title="">url</var>'s
     <a href="#concept-url-fragment" title="concept-url-fragment">fragment</a> to
     the empty string and <var title="">state</var> to
     <b title="">fragment state</b>.

     <li><p>Otherwise, if <var title="">c</var> is none of
     <a href="#eof-code-point">EOF code point</a>, U+0009, U+000A, and U+000D,
     <a href="#url-escape">URL escape</a> <var title="">c</var> using the
     <a href="#url-simple-escape-set">URL simple escape set</a>, and append the result to
     <var title="">url</var>'s
     <a href="#concept-url-scheme-data" title="concept-url-scheme-data">scheme data</a>.
    </ol>

   <dt><b title="">no scheme state</b>
   <dd>
    <p>If <var title="">base</var> is null, or <var title="">base</var>'s
    <a href="#concept-url-scheme" title="concept-url-scheme">scheme</a> is not a
    <a href="#relative-scheme">relative scheme</a>, <a href="#neuter">neuter</a> <var title="">url</var>,
    and then return <var title="">url</var>.

    <p class="note">You do not want to check <var title="">base</var>'s
    <a href="#relative-flag">relative flag</a> here, as the
    <a href="#concept-url-scheme" title="concept-url-scheme">scheme</a> itself can have been
    changed to something non-sensical through the
    <a href="#dom-url-protocol"><code title="dom-URL-protocol">protocol</code></a> attribute.
    <!-- XXX maybe disallow setting protocol to non-sensical values -->

    <p>Otherwise, set <var title="">state</var> to <b title="">relative state</b>,
    and decrease <var title="">pointer</var> by one.

   <dt><b title="">relative state</b>
   <dd>
    <p>Set <var title="">url</var>'s <a href="#relative-flag">relative flag</a>, set
    <var title="">url</var>'s <a href="#concept-url-scheme" title="concept-url-scheme">scheme</a> to
    <var title="">base</var>'s <a href="#concept-url-scheme" title="concept-url-scheme">scheme</a>,
    and then, based on <var title="">c</var>:

    <dl class="switch">
     <dt><a href="#eof-code-point">EOF code point</a>
     <dd>
      <p>Set <var title="">url</var>'s <a href="#concept-url-host" title="concept-url-host">host</a>
      to <var title="">base</var>'s <a href="#concept-url-host" title="concept-url-host">host</a>,
      <var title="">url</var>'s <a href="#concept-url-port" title="concept-url-port">port</a> to
      <var title="">base</var>'s <a href="#concept-url-port" title="concept-url-port">port</a>,
      <var title="">url</var>'s <a href="#concept-url-path" title="concept-url-path">path</a> to
      <var title="">base</var>'s <a href="#concept-url-path" title="concept-url-path">path</a>,
      <var title="">url</var>'s <a href="#concept-url-query" title="concept-url-query">query</a> to
      <var title="">base</var>'s <a href="#concept-url-query" title="concept-url-query">query</a>,
      and then terminate this algorithm.

     <dt>"<code title="">/</code>"
     <dt>"<code title="">\</code>"
     <dd>
      <p>If <var title="">remaining</var> starts with either
      "<code title="">/</code>" or "<code title="">\</code>", increase
      <var title="">pointer</var> by one, and run these steps:

      <ol>
       <li><p>If <var title="">url</var>'s <a href="#concept-url-scheme" title="concept-url-scheme">scheme</a> is
       "<code title="">file</code>", set <var title="">state</var> to
       <b title="">file host state</b>.

       <li><p>Otherwise set <var title="">state</var> to
       <b title="">authority start state</b>.
      </ol>

      <p>Otherwise, set
      <var title="">url</var>'s <a href="#concept-url-host" title="concept-url-host">host</a> to
      <var title="">base</var>'s <a href="#concept-url-host" title="concept-url-host">host</a>,
      <var title="">url</var>'s <a href="#concept-url-port" title="concept-url-port">port</a> to
      <var title="">base</var>'s <a href="#concept-url-port" title="concept-url-port">port</a>,
      <var title="">state</var> to <b title="">relative path start state</b>,
      and decrease <var title="">pointer</var> by one.

     <dt>"<code title="">?</code>"
     <dd><p>Set
     <var title="">url</var>'s <a href="#concept-url-host" title="concept-url-host">host</a> to
     <var title="">base</var>'s <a href="#concept-url-host" title="concept-url-host">host</a>,
     <var title="">url</var>'s <a href="#concept-url-port" title="concept-url-port">port</a> to
     <var title="">base</var>'s <a href="#concept-url-port" title="concept-url-port">port</a>,
     <var title="">url</var>'s <a href="#concept-url-path" title="concept-url-path">path</a> to
     <var title="">base</var>'s <a href="#concept-url-path" title="concept-url-path">path</a>,
     <var title="">url</var>'s <a href="#concept-url-query" title="concept-url-query">query</a> to the empty string,
     and <var title="">state</var> to <b title="">query state</b>.

     <dt>"<code title="">#</code>"
     <dd><p>Set
     <var title="">url</var>'s <a href="#concept-url-host" title="concept-url-host">host</a> to
     <var title="">base</var>'s <a href="#concept-url-host" title="concept-url-host">host</a>,
     <var title="">url</var>'s <a href="#concept-url-port" title="concept-url-port">port</a> to
     <var title="">base</var>'s <a href="#concept-url-port" title="concept-url-port">port</a>,
     <var title="">url</var>'s <a href="#concept-url-path" title="concept-url-path">path</a> to
     <var title="">base</var>'s <a href="#concept-url-path" title="concept-url-path">path</a>,
     <var title="">url</var>'s <a href="#concept-url-query" title="concept-url-query">query</a> to
     <var title="">base</var>'s <a href="#concept-url-query" title="concept-url-query">query</a>,
     <var title="">url</var>'s <a href="#concept-url-fragment" title="concept-url-fragment">fragment</a> to the empty string,
     and <var title="">state</var> to <b title="">fragment state</b>.

     <dt>Otherwise
     <dd><p>Set
     <var title="">url</var>'s <a href="#concept-url-host" title="concept-url-host">host</a> to
     <var title="">base</var>'s <a href="#concept-url-host" title="concept-url-host">host</a>,
     <var title="">url</var>'s <a href="#concept-url-port" title="concept-url-port">port</a> to
     <var title="">base</var>'s <a href="#concept-url-port" title="concept-url-port">port</a>,
     <var title="">url</var>'s <a href="#concept-url-path" title="concept-url-path">path</a> to
     <var title="">base</var>'s <a href="#concept-url-path" title="concept-url-path">path</a>, then
     remove <var title="">url</var>'s <a href="#concept-url-path" title="concept-url-path">path</a>'s last string, set
     <var title="">state</var> to <b title="">relative path start state</b>,
     and decrease <var title="">pointer</var> by one.
    </dl>

   <dt><b title="">authority start state</b>
   <dd><p>If <var title="">c</var> is neither "<code title="">/</code>" nor
   "<code title="">\</code>", set <var title="">state</var> to
   <b title="">authority state</b>, and decrease <var title="">pointer</var> by one.

   <dt><b title="">authority state</b>
   <dd>
    <ol>
     <li>
      <p>If <var title="">c</var> is <code title="">@</code>", run these substeps:

      <ol>
       <li><p>If the <var title="">@ flag</var> is set, append
       "<code title="">%40</code>" to <var title="">url</var>'s
       <a href="#concept-url-userinfo" title="concept-url-userinfo">userinfo</a>.

       <li><p>Set the <var title="">@ flag</var>.

       <li><p>For each code point in <var title="">buffer</var>,
       <a href="#url-escape">URL escape</a> it using the
       <a href="#url-default-escape-set">URL default escape set</a>, and append the result to
       <var title="">url</var>'s <a href="#concept-url-userinfo" title="concept-url-userinfo">userinfo</a>.

       <li><p>Set <var title="">buffer</var> to the empty string.
      </ol>

     <li><p>If <var title="">c</var> is one of <a href="#eof-code-point">EOF code point</a>,
     "<code title="">/</code>", "<code title="">\</code>", "<code title="">?</code>",
     and "<code title="">#</code>", decrease <var title="">pointer</var> by the
     number of code points in <var title="">buffer</var>, set
     <var title="">buffer</var> to the empty string, and
     <var title="">state</var> to <b title="">host state</b>.

     <li><p>Otherwise, if <var title="">c</var> is none of U+0009, U+000A, and
     U+000D, append <var title="">c</var> to <var title="">buffer</var>.
    </ol>

   <dt><b title="">file host state</b>
   <dd>
    <ol>
     <li>
      <p>If <var title="">c</var> is one of <a href="#eof-code-point">EOF code point</a>,
      "<code title="">/</code>", "<code title="">\</code>", "<code title="">?</code>",
      and "<code title="">#</code>", decrease <var title="">pointer</var> by one,
      and run these substeps:

      <ol>
       <li>
        <p>If <var title="">buffer</var> consists of two code points, of
        which the first is an <a href="#ascii-alpha">ASCII alpha</a> and the second is
        either "<code title="">:</code>" or "<code title="">|</code>", set state
        to <b title="">relative path state</b>.

        <p class="note">This is a quirk for parsing Windows drive letters and
        therefore <var title="">buffer</var> is not reset here.

       <li><p>Otherwise, set
       <var title="">url</var>'s <a href="#concept-url-host" title="concept-url-host">host</a> to
       <var title="">buffer</var>,<!-- XXX host normalize -->
       <var title="">buffer</var> to the empty string,
       and <var title="">state</var> to <b title="">relative path start state</b>.
      </ol>

     <li><p>Otherwise, if <var title="">c</var> is none of U+0009, U+000A, and
     U+000D, append <var title="">c</var> to <var title="">buffer</var>.
    </ol>

   <dt><b title="">host state</b>
   <dt><b title="">hostname state</b>
   <dd>
    <ol>
     <li>
      <p>If <var title="">c</var> is "<code title="">:</code>" and the
      <var title="">[] flag</var> is unset, run these substeps:

      <ol>
       <li><p>Set <var title="">url</var>'s <a href="#concept-url-host" title="concept-url-host">host</a> to
       <var title="">buffer</var>,<!-- XXX host normalize -->
       <var title="">buffer</var> to the empty string,
       and <var title="">state</var> to <b title="">port state</b>.

       <li><p>If <var title="">state override</var> is <b title="">hostname state</b>,
       terminate this algorithm.
      </ol>

     <li>
      <p>Otherwise, if <var title="">c</var> is one of
      <a href="#eof-code-point">EOF code point</a>, "<code title="">/</code>",
      "<code title="">\</code>", "<code title="">?</code>", and
      "<code title="">#</code>", decrease <var title="">pointer</var> by one, and
      run these substeps:

      <ol>
       <li><p>Set <var title="">url</var>'s <a href="#concept-url-host" title="concept-url-host">host</a> to
       <var title="">buffer</var>,<!-- XXX host normalize -->
       <var title="">buffer</var> to the empty string,
       and <var title="">state</var> to <b title="">relative path start state</b>.

       <li><p>If <var title="">state override</var> is given, terminate this
       algorithm.
      </ol>

     <li>
      <p>Otherwise, if <var title="">c</var> is none of U+0009, U+000A, and
      U+000D, run these substeps:

      <ol>
       <li><p>If <var title="">c</var> is "<code title="">[</code>", set the
       <var title="">[] flag</var>.

       <li><p>If <var title="">c</var> is "<code title="">]</code>", unset the
       <var title="">[] flag</var>.

       <li><p>Append <var title="">c</var> to <var title="">buffer</var>.
      </ol>
    </ol>

   <dt><b title="">port state</b>
   <dd>
    <ol>
     <li><p>If <var title="">c</var> is in the range U+0030 through to U+0039,
     append <var title="">c</var> to <var title="">buffer</var>.

     <li>
      <p>Otherwise, if <var title="">c</var> is one of
      <a href="#eof-code-point">EOF code point</a>, "<code title="">/</code>",
      "<code title="">\</code>", "<code title="">?</code>", and
      "<code title="">#</code>", or <var title="">state override</var> is given, run
      these substeps:
      <ol>
       <li><p class="XXX">parse buffer and set port

       <li><p>If <var title="">state override</var> is given, terminate this
       algorithm.

       <li><p>Set <var title="">buffer</var> to the empty string,
       <var title="">state</var> to <b title="">relative path start state</b>, and
       decrease <var title="">pointer</var> by one.
      </ol>

     <li><p>Otherwise, <a href="#neuter">neuter</a> <var title="">url</var>, and then
     return <var title="">url</var>.
    </ol>

   <dt><b title="">relative path start state</b>
   <dd><p>Set <var title="">state</var> to <b title="">relative path state</b> and
   if <var title="">c</var> is neither "<code title="">/</code>" nor
   "<code title="">\</code>", decrease <var title="">pointer</var> by one.

   <dt><b title="">relative path state</b>
   <dd>
    <ol>
     <li>
      <p>If either <var title="">c</var> is one of
      <a href="#eof-code-point">EOF code point</a>, "<code title="">/</code>", and
      "<code title="">\</code>", or <var title="">state override</var> is not given and
      <var title="">c</var> is one of "<code title="">?</code>" and
      "<code title="">#</code>", run these substeps:
      <ol>
       <li><p>If <var title="">buffer</var> is "<code title="">..</code>" and
       <var title="">c</var> is one of <a href="#eof-code-point">EOF code point</a>,
       "<code title="">/</code>", and "<code title="">\</code>", set the last
       string in <var title="">url</var>'s <a href="#concept-url-path" title="concept-url-path">path</a> to the empty
       string.

       <li><p>Otherwise, if <var title="">buffer</var> is
       "<code title="">..</code>", remove the last string from
       <var title="">url</var>'s <a href="#concept-url-path" title="concept-url-path">path</a>.

       <li><p>Otherwise, if <var title="">buffer</var> is
       "<code title="">.</code>" and <var title="">c</var> is one of
       <a href="#eof-code-point">EOF code point</a>, "<code title="">/</code>", and
       "<code title="">\</code>", append an empty string to
       <var title="">url</var>'s <a href="#concept-url-path" title="concept-url-path">path</a>.

       <li>
        <p>Otherwise, if <var title="">buffer</var> is not
        "<code title="">.</code>", run these inner substeps:

        <ol>
         <li>
          <p>If <var title="">url</var>'s <a href="#concept-url-scheme" title="concept-url-scheme">scheme</a> is
          "<code title="">file</code>", <var title="">url</var>'s <a href="#concept-url-path" title="concept-url-path">path</a>
          is the empty list, <var title="">buffer</var> consists of two
          code points, of which the first is an <a href="#ascii-alpha">ASCII alpha</a>,
          and the second is either "<code title="">:</code>" or
          "<code title="">|</code>", replace the second code point in
          <var title="">buffer</var> with "<code title="">:</code>".

          <p class="note">Windows drive letters are beautiful, no?

         <li><p>Append <var title="">buffer</var> to
         <var title="">url</var>'s <a href="#concept-url-path" title="concept-url-path">path</a>.
        </ol>

       <li><p>Set <var title="">buffer</var> to the empty string.

       <li><p>If <var title="">c</var> is "<code title="">?</code>", set
       <var title="">url</var>'s <a href="#concept-url-query" title="concept-url-query">query</a> to the empty string,
       and <var title="">state</var> to <b title="">query state</b>.

       <li><p>If <var title="">c</var> is "<code title="">#</code>", set
       <var title="">url</var>'s <a href="#concept-url-fragment" title="concept-url-fragment">fragment</a> to the empty string,
       and <var title="">state</var> to <b title="">fragment state</b>.
      </ol>

     <li><p>Otherwise, if <var title="">c</var> is "<code title="">%</code>" and
     <var title="">remaining</var> starts with either "<code title="">2E</code>"
     or "<code title="">2e</code>", increase <var title="">pointer</var> by two,
     and append "<code title="">.</code>" to <var title="">buffer</var>.
     <!-- Chrome unescapes more here; Safari does nothing -->

     <li><p>Otherwise, if <var title="">c</var> is none of U+0009, U+000A, and
     U+000D, <a href="#url-escape">URL escape</a> <var title="">c</var> using the
     <a href="#url-default-escape-set">URL default escape set</a>, and append the result to
     <var title="">buffer</var>.
    </ol>

   <dt><b title="">query state</b>
   <dd>
    <ol>
     <li><p>If <var title="">state override</var> is not given and <var title="">c</var>
     is "<code title="">#</code>", set
     <var title="">url</var>'s <a href="#concept-url-fragment" title="concept-url-fragment">fragment</a> to the empty string,
     and state to <b title="">fragment state</b>.

     <li>
      <p>Otherwise, if <var title="">c</var> is none of
      <a href="#eof-code-point">EOF code point</a>, U+0009, U+000A, and U+000D,
      <a href="#url-escape">URL escape</a> <var title="">c</var> using the
      <a href="#url-query-escape-set">URL query escape set</a> and
      <var title="">encoding override</var>, and append the result to
      <var title="">url</var>'s <a href="#concept-url-query" title="concept-url-query">query</a>.

      <p class="XXX">Only use <var title="">encoding override</var> for
      http/https/file rather than for all relative schemes?
      <!-- http://simon.html5.org/test/url/url-encoding.html -->
    </ol>

   <dt><b title="">fragment state</b>
   <dd><p>If <var title="">c</var> is none of <a href="#eof-code-point">EOF code point</a>,
   U+0009, U+000A, and U+000D, <a href="#url-escape">URL escape</a> <var title="">c</var>
   using the <span title="">URL simple escape set</span>, and append the result
   to <var title="">url</var>'s <a href="#concept-url-fragment" title="concept-url-fragment">fragment</a>.
   <!-- if people complain about this do not forget that results may differ
        depending on whether or not a relative scheme is in play -->
  </dl>

 <li><p>Return <var title="">url</var>.
</ol>

<h3 id="serializing"><span class="secno">4.3 </span>Serializing</h3>

<p class="note">The serializing algorithms assume a
<a href="#concept-parsed-url" title="concept-parsed-url">parsed URL</a>'s
<a href="#fatal-error-flag">fatal error flag</a> is not set.

<p>To <dfn id="concept-url-serializer" title="concept-url-serializer">serialize</dfn> a
<a href="#concept-parsed-url" title="concept-parsed-url">parsed URL</a>, run these steps:

<ol>
 <li><p>Let <var title="">output</var> be the result of
 <a href="#concept-url-serializer-without-fragment" title="concept-url-serializer-without-fragment">serializing without fragment</a>.

 <li><p>If <a href="#concept-url-fragment" title="concept-url-fragment">fragment</a> is non-null,
 append "<code title="">#</code>" concatenated with
 <a href="#concept-url-fragment" title="concept-url-fragment">fragment</a> to <var title="">output</var>.

 <li><p>Return <var title="">output</var>.
</ol>

<p>To
<dfn id="concept-url-serializer-without-fragment" title="concept-url-serializer-without-fragment">serialize without fragment</dfn>
a <a href="#concept-parsed-url" title="concept-parsed-url">parsed URL</a>, run these steps:
<!-- better wording anyone?! -->

<ol>
 <li><p>Let <var title="">output</var> be
 <a href="#concept-url-scheme" title="concept-url-scheme">scheme</a> and
 "<code title="">:</code>" concatenated.

 <li>
  <p>If the <a href="#relative-flag">relative flag</a> is set:

  <ol>
   <li><p>Append "<code title="">//</code>" to <var title="">output</var>.

   <li><p>If <a href="#concept-url-userinfo" title="concept-url-userinfo">userinfo</a> is not
   the empty string, append
   <a href="#concept-url-userinfo" title="concept-url-userinfo">userinfo</a> concatenated with
   "<code title="">@</code>" to <var title="">output</var>.

   <li><p>Append <a href="#concept-url-host" title="concept-url-host">host</a> to
   <var title="">output</var>.

   <li><p>If <a href="#concept-url-port" title="concept-url-port">port</a> is not
   the empty string, append "<code title="">:</code>" concatenated with
   <a href="#concept-url-port" title="concept-url-port">port</a> to <var title="">output</var>.

   <li><p>Append "<code title="">/</code>" concatenated with the strings in
   <a href="#concept-url-path" title="concept-url-path">path</a> (including empty strings),
   separated from each other by "<code title="">/</code>" to
   <var title="">output</var>.

   <li><p>If <a href="#concept-url-query" title="concept-url-query">query</a> is non-null, append
   "<code title="">?</code>" concatenated with
   <a href="#concept-url-query" title="concept-url-query">query</a> to <var title="">output</var>.
  </ol>

 <li><p>Otherwise, if the <a href="#relative-flag">relative flag</a> is unset, append
 <a href="#concept-url-scheme-data" title="concept-url-scheme-data">scheme data</a> to
 <var title="">output</var>.

 <li><p>Return <var title="">output</var>.
</ol>



<h2 id="api"><span class="secno">5 </span>API</h2>

<!-- XXX http://lists.w3.org/Archives/Public/public-script-coord/2012OctDec/0082.html
     s/DOMString/UTFString -->

<pre class="idl">[<a href="#dom-url" title="dom-URL">Constructor</a>(DOMString <var title="">url</var>, optional (<a href="#url">URL</a> or DOMString) <var title="">base</var>)]
interface <dfn id="url">URL</dfn> {
};
<a href="#url">URL</a> implements <a href="#urlutils">URLUtils</a>;

[NoInterfaceObject]
interface <dfn id="urlutils">URLUtils</dfn> {
  stringifier attribute DOMString <a href="#dom-url-href" title="dom-URL-href">href</a>;
  readonly attribute DOMString <a href="#dom-url-origin" title="dom-URL-origin">origin</a>;

           attribute DOMString <a href="#dom-url-protocol" title="dom-URL-protocol">protocol</a>;
           attribute DOMString <a href="#dom-url-host" title="dom-URL-host">host</a>;
           attribute DOMString <a href="#dom-url-hostname" title="dom-URL-hostname">hostname</a>;
           attribute DOMString <a href="#dom-url-port" title="dom-URL-port">port</a>;
           attribute DOMString <a href="#dom-url-pathname" title="dom-URL-pathname">pathname</a>;
           attribute DOMString <a href="#dom-url-search" title="dom-URL-search">search</a>;
  readonly attribute <a href="#urlquery">URLQuery</a> <a href="#dom-url-query" title="dom-URL-query">query</a>;
           attribute DOMString <a href="#dom-url-hash" title="dom-URL-hash">hash</a>;
};</pre>

<!-- Ideas:
           attribute DOMString user;
           attribute DOMString password; // or maybe userinfo instead?
           attribute DOMString basename; // last segment of path (Simon Sapin)
           sequence<DOMString> getPath();
           void setPath(DOMString segments...);

     Maybe also a way of comparing URLs? Or maybe rather a way to normalize
     a URL in a way that makes string comparison work better.

     Working with relative paths is another thing we could improve. E.g. a
     relPathname setter that would resolve the given value against pathname.

     Could make manipulation of host easier by exposing the labels similarly
     to the proposal for path segments above. (Should never expose
     effective TLD as it's evil.) -->

<p>Any object implementing <a href="#urlutils"><code>URLUtils</code></a> has an associated
<a href="#urlquery"><code>URLQuery</code></a> object,
<a href="#concept-parsed-url" title="concept-parsed-url">parsed URL</a> <b title="">url</b>,
<a href="#concept-base-url" title="concept-base-url">base URL</a> <b title="">base</b>,
<b title="">input</b>, and <b title="">query encoding</b>.
Unless stated otherwise, <b title="">query encoding</b> is
<a class="external" data-anolis-spec="encoding" href="http://encoding.spec.whatwg.org/#utf-8">utf-8</a>. The others must be set on
creation by the specification using <a href="#urlutils"><code>URLUtils</code></a>.
<!-- standard > specification -->

<p class="note">The associated <b title="">query encoding</b> is a legacy concept
only relevant for HTML. <a class="informative" href="#refsHTML">[HTML]</a>


<h3 id="constructors"><span class="secno">5.1 </span>Constructors</h3> <!-- "constructor" causes dfn.js to fail -->

<p>The
<dfn id="dom-url" title="dom-URL"><code>URL(<var title="">url</var>, <var title="">base</var>)</code></dfn>
constructor must run these steps:

<ol>
 <li><p>If <var title="">base</var> is not given, set it to
 "<code title="">about:blank</code>".
 <!-- URLUtils needs an associated base URL -->

 <li><p>If <var title="">base</var> is a string,
 <a href="#concept-url-parser" title="concept-url-parser">parse</a> <var title="">base</var> and set
 <var title="">base</var> to the result of that algorithm.

 <li><p>If <var title="">base</var>'s <a href="#fatal-error-flag">fatal error flag</a> is set,
 <a class="external" data-anolis-spec="dom" href="http://dom.spec.whatwg.org/#concept-throw" title="concept-throw">throw</a> an
 "<a href="http://dom.spec.whatwg.org/#invalidstateerror"><code class="external" data-anolis-spec="dom">InvalidStateError</code></a>" exception.

 <li><p><a href="#concept-url-parser" title="concept-url-parser">Parse</a> <var title="">url</var>
 with <a href="#concept-base-url" title="concept-base-url">base URL</a> <var title="">base</var>,
 and then associate the result with a new <a href="#url"><code>URL</code></a> object as its
 <b title="">url</b>, associate <var title="">base</var> with the new object as
 its <b title="">base</b>, associate <var title="">url</var> with the new object
 as its <b title="">input</b>, and then return the new object.
</ol>


<h3 id="interface-urlutils"><span class="secno">5.2 </span>Interface <code title="">URLUtils</code></h3>

<p class="note">The <a href="#urlutils"><code>URLUtils</code></a> interface is not exposed on the
global object. It augments other interfaces, such as <a href="#url"><code>URL</code></a>.

<p>The <dfn id="dom-url-href" title="dom-URL-href"><code>href</code></dfn> attribute must run
these steps:

<ol>
 <li><p>If the <a href="#fatal-error-flag">fatal error flag</a> is set, return the associated
 <b title="">input</b>.

 <li><p>Return the <a href="#concept-url-serializer" title="concept-url-serializer">serialization</a>.
</ol>

<p>Setting the <a href="#dom-url-href"><code title="dom-URL-href">href</code></a> attribute must
run these steps:

<ol>
 <li><p><a href="#clear">Clear</a>.

 <li><p>Set the associated <b title="">input</b> to the given value.

 <li><p><a href="#concept-url-parser" title="concept-url-parser">Parse</a> <b title="">input</b>
 with <a href="#concept-base-url" title="concept-base-url">base URL</a> <b title="">base</b> and
 <b title="">query encoding</b> as <var title="">encoding override</var>, and then
 set <b title="">url</b> to the result.
</ol>

<p>The <dfn id="dom-url-origin" title="dom-URL-origin"><code>origin</code></dfn> attribute must
return the <a class="external" data-anolis-spec="origin" href="http://tools.ietf.org/html/rfc6454#section-6.1">Unicode serialization</a> of
the <a href="#concept-parsed-url" title="concept-parsed-url">parsed URL</a>'s
<a class="external" data-anolis-spec="origin" href="http://tools.ietf.org/html/rfc6454#section-4">origin</a>.
<a href="#refsORIGIN">[ORIGIN]</a>

<p class="note">It returns the Unicode rather than the ASCII serialization for
compatibility with HTML's <code>MessageEvent</code> feature.
<a class="informative" href="#refsHTML">[HTML]</a>

<p>The <dfn id="dom-url-protocol" title="dom-URL-protocol"><code>protocol</code></dfn> attribute
must return <a href="#concept-url-scheme" title="concept-url-scheme">scheme</a> and
"<code title="">:</code>" concatenated.

<p class="note">In case the <a href="#fatal-error-flag">fatal error flag</a> is set this will
cause it to return "<code title="">:</code>".

<p>Setting the <a href="#dom-url-protocol"><code title="dom-URL-protocol">protocol</code></a> attribute must
run these steps:

<ol>
 <li><p>If the <a href="#fatal-error-flag">fatal error flag</a> is set, terminate these steps.

 <li><p><a href="#concept-url-parser" title="concept-url-parser">Parse</a> the given value and
 "<code title="">:</code>" concatenated with the associated <b title="">url</b> as
 <var title="">url</var> and <b title="">scheme start state</b> as
 <var title="">state override</var>.
</ol>

<p>The <dfn id="dom-url-host" title="dom-URL-host"><code>host</code></dfn> attribute must run
these steps:

<ol>
 <li><p>If the <a href="#fatal-error-flag">fatal error flag</a> is set, return the empty string.

 <li><p>If <a href="#concept-url-port" title="concept-url-port">port</a> is the empty string,
 return <a href="#concept-url-host" title="concept-url-host">host</a>.

 <li><p>Return <a href="#concept-url-host" title="concept-url-host">host</a>,
 "<code title="">:</code>", and <a href="#concept-url-port" title="concept-url-port">port</a>
 concatenated.
</ol>

<p>Setting the <a href="#dom-url-host"><code title="dom-URL-host">host</code></a> attribute must run these
steps:

<ol>
 <li><p>If the <a href="#fatal-error-flag">fatal error flag</a> is set, or the
 <a href="#relative-flag">relative flag</a> is unset, terminate these steps.

 <li><p><a href="#concept-url-parser" title="concept-url-parser">Parse</a> the given value with the
 associated <b title="">url</b> as <var title="">url</var>, and
 <b title="">host state</b> as <var title="">state override</var>.
</ol>

<p>The <dfn id="dom-url-hostname" title="dom-URL-hostname"><code>hostname</code></dfn> attribute
must return <a href="#concept-url-host" title="concept-url-host">host</a>.

<p>Setting the <a href="#dom-url-hostname"><code title="dom-URL-hostname">hostname</code></a> attribute must
run these steps:

<ol>
 <li><p>If the <a href="#fatal-error-flag">fatal error flag</a> is set, or the
 <a href="#relative-flag">relative flag</a> is unset, terminate these steps.

 <li><p><a href="#concept-url-parser" title="concept-url-parser">Parse</a> the given value with the
 associated <b title="">url</b> as <var title="">url</var>, and
 <b title="">hostname state</b> as <var title="">state override</var>.
</ol>

<p>The <dfn id="dom-url-port" title="dom-URL-port"><code>port</code></dfn> attribute must return
<a href="#concept-url-port" title="concept-url-port">port</a>.

<p>Setting the <a href="#dom-url-port"><code title="dom-URL-port">port</code></a> attribute must run these
steps:

<ol>
 <li><p>If the <a href="#fatal-error-flag">fatal error flag</a> is set, the
 <a href="#relative-flag">relative flag</a> is unset, or
 <a href="#concept-url-scheme" title="concept-url-scheme">scheme</a> is "<code title="">file</code>",
 terminate these steps.

 <li><p><a href="#concept-url-parser" title="concept-url-parser">Parse</a> the given value with the
 associated <b title="">url</b> as <var title="">url</var>, and
 <b title="">port state</b> as <var title="">state override</var>.
</ol>

<p>The <dfn id="dom-url-pathname" title="dom-URL-pathname"><code>pathname</code></dfn> attribute
must run these steps:

<ol>
 <li><p>If the <a href="#fatal-error-flag">fatal error flag</a> is set, return the empty string.

 <li><p>If the <a href="#relative-flag">relative flag</a> is unset, return
 <a href="#concept-url-scheme-data" title="concept-url-scheme-data">scheme data</a>.

 <li><p>Return "<code title="">/</code>" concatenated with the strings in
 <a href="#concept-url-path" title="concept-url-path">path</a> (including empty strings),
 separated from each other by "<code title="">/</code>".
</ol>

<p>Setting the <a href="#dom-url-pathname"><code title="dom-URL-pathname">pathname</code></a> attribute must
run these steps:

<ol>
 <li><p>If the <a href="#fatal-error-flag">fatal error flag</a> is set, or the
 <a href="#relative-flag">relative flag</a> is unset, terminate these steps.

 <li><p>Set <a href="#concept-url-path" title="concept-url-path">path</a> to the empty list.

 <li><p><a href="#concept-url-parser" title="concept-url-parser">Parse</a>the given value with the
 associated <b title="">url</b> as <var title="">url</var>, and
 <b title="">relative path start state</b> as <var title="">state override</var>.
</ol>

<p>The <dfn id="dom-url-search" title="dom-URL-search"><code>search</code></dfn> attribute must
run these steps:

<ol>
 <li><p>If the <a href="#fatal-error-flag">fatal error flag</a> is set, or
 <a href="#concept-url-query" title="concept-url-query">query</a> is either null or
 the empty string, return the empty string.

 <li><p>Return "<code title="">?</code>" concatenated with
 <a href="#concept-url-query" title="concept-url-query">query</a>.
</ol>

<p>Setting the <a href="#dom-url-search"><code title="dom-URL-search">search</code></a> attribute must run
these steps:

<ol>
 <li><p>If the <a href="#fatal-error-flag">fatal error flag</a> is set, or the
 <a href="#relative-flag">relative flag</a> is unset, terminate these steps.

 <li><p>If the given value is the empty string, set
 <a href="#concept-url-query" title="concept-url-query">query</a> to null, and terminate these
 steps.

 <li><p>Let <var title="">input</var> be the given value with a single leading
 "<code title="">?</code>" removed, if any.

 <li><p>Set <a href="#concept-url-query" title="concept-url-query">query</a> to the empty string.

 <li><p><a href="#concept-url-parser" title="concept-url-parser">Parse</a> <var title="">input</var>
 with the associated <b title="">url</b> as <var title="">url</var>,
 <b title="">query state</b> as <var title="">state override</var>, and the
 associated <b title="">query encoding</b> as <var title="">encoding override</var>.
</ol>

<p>The <dfn id="dom-url-query" title="dom-URL-query"><code>query</code></dfn> attribute must
return the associated <a href="#urlquery"><code>URLQuery</code></a> object.

<p>The <dfn id="dom-url-hash" title="dom-URL-hash"><code>hash</code></dfn> attribute must run
these steps:

<ol>
 <li><p>If the <a href="#fatal-error-flag">fatal error flag</a> is set, or
 <a href="#concept-url-fragment" title="concept-url-fragment">fragment</a> is either null or
 the empty string, return the empty string.

 <li><p>Return "<code title="">#</code>" concatenated with
 <a href="#concept-url-fragment" title="concept-url-fragment">fragment</a>.
</ol>

<p>Setting the <a href="#dom-url-hash"><code title="dom-URL-hash">hash</code></a> attribute must run these
steps:

<ol>
 <li><p>If the <a href="#fatal-error-flag">fatal error flag</a> is set, or the
 <a href="#concept-url-scheme" title="concept-url-scheme">scheme</a> is
 "<code title="">javascript</code>", terminate these steps.

 <li><p>If the given value is the empty string, set
 <a href="#concept-url-fragment" title="concept-url-fragment">fragment</a> to null, and terminate
 these steps.

 <li><p>Let <var title="">input</var> be the given value with a single leading
 "<code title="">#</code>" removed, if any.

 <li><p>Set <a href="#concept-url-fragment" title="concept-url-fragment">fragment</a> to
 the empty string.

 <li><p><a href="#concept-url-parser" title="concept-url-parser">Parse</a> <var title="">input</var>
 with the associated <b title="">url</b> as <var title="">url</var>, and
 <b title="">fragment state</b> as <var title="">state override</var>.
</ol>


<h3 id="interface-urlquery"><span class="secno">5.3 </span>Interface <code title="">URLQuery</code></h3>

<pre class="idl">interface <dfn id="urlquery">URLQuery</dfn> {
  DOMString? <span title="dom-URLQuery-get">get</span>(DOMString <var title="">name</var>);
  sequence&lt;DOMString&gt; <span title="dom-URLQuery-getAll">getAll</span>(DOMString <var title="">name</var>);
  void <span title="dom-URLQuery-set">set</span>(DOMString name, (sequence&lt;DOMString&gt; or DOMString) <var title="">value</var>);
  void <span title="dom-URLQuery-delete">delete</span>(DOMString <var title="">name</var>);
};</pre>

<p class="XXX">...



<h2 class="no-num" id="references">References</h2>
<div id="anolis-references"><dl><dt id="refsENCODING">[ENCODING]
<dd><cite><a href="http://encoding.spec.whatwg.org/">Encoding Standard</a></cite>, Anne van Kesteren. WHATWG.

<dt id="refsHTML">[HTML]
<dd>(Non-normative) <cite><a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/">HTML</a></cite>, Ian Hickson. WHATWG.

<dt id="refsORIGIN">[ORIGIN]
<dd><cite><a href="http://tools.ietf.org/html/rfc6454">The Web Origin Concept</a></cite>, Adam Barth. IETF.

<dt id="refsRFC2119">[RFC2119]
<dd><cite><a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a></cite>, Scott Bradner. IETF.

<dt id="refsRFC3986">[RFC3986]
<dd>(Non-normative) <cite><a href="http://tools.ietf.org/html/rfc3986">Uniform Resource Identifier (URI): Generic Syntax</a></cite>, Tim Berners-Lee, Roy Fielding and Larry Masinter. IETF.

<dt id="refsRFC3987">[RFC3987]
<dd>(Non-normative) <cite><a href="http://tools.ietf.org/html/rfc3987">Internationalized Resource Identifiers (IRIs)</a></cite>, Martin Dürst and Michel Suignard. IETF.

</dl></div>



<h2 class="no-num" id="acknowledgments">Acknowledgments</h2>

<p>Thanks to
Adam Barth,
Alexandre Morgaut,
Boris Zbarsky,
David Sheets,
Erik Arvidsson,
Gavin Carothers,
Glenn Maynard,
Henri Sivonen,
Ian Hickson,
James Graham,
James Manger,
Mathias Bynens,
Michael™ Smith,
Rodney Rehm,
Simon Pieters,
Tab Atkins, and
Tantek Çelik
for being awesome!

<!-- http://dvcs.w3.org/hg/url/raw-file/feb258fa6ab5/Overview.html -->

<p>While this standard has been written from scratch, special thanks should
be extended to the editors of the various specifications that previously
defined what we now call URLs:
Larry Masinter,
Martin Dürst,
Michel Suignard,
Roy Fielding, and
Tim Berners-Lee.

<!-- RFC 3986, RFC 3987 -->



<script id="head" src="http://www.whatwg.org/specs/web-apps/current-work/dfn.js"></script>
